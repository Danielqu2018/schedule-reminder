# 团队项目管理系统 - 数据库设计

## 系统概述

这是一个支持团队协作的项目管理系统，从简单的个人日程升级为完整的团队项目管理工具。

## 核心概念

1. **团队（Team）**：组织的基本单位，包含多个成员
2. **工作组（Work Group）**：团队内的工作分组，每个工作组专注于特定任务
3. **任务（Task）**：团队需要完成的主要任务
4. **工作子项（Work Item）**：任务的具体工作项，有执行顺序关系
5. **成员（Member）**：团队成员，可以是多个工作组的成员

## 数据库表结构

### 1. teams 表（团队表）

```sql
CREATE TABLE teams (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  owner_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明：**
- `id`: 主键
- `name`: 团队名称
- `description`: 团队描述
- `owner_id`: 团队负责人/创建者
- `created_at`: 创建时间

---

### 2. team_members 表（团队成员表）

```sql
CREATE TABLE team_members (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  team_id BIGINT REFERENCES teams(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  role VARCHAR(50) DEFAULT 'member', -- owner, admin, member
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(team_id, user_id)
);
```

**字段说明：**
- `id`: 主键
- `team_id`: 所属团队ID
- `user_id`: 用户ID
- `role`: 角色（owner/管理员/成员）
- `joined_at`: 加入时间

**角色说明：**
- `owner`: 团队所有者，完全权限
- `admin`: 管理员，可管理工作组
- `member`: 普通成员，只能查看和分配给自己的任务

---

### 3. work_groups 表（工作组表）

```sql
CREATE TABLE work_groups (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  team_id BIGINT REFERENCES teams(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  leader_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明：**
- `id`: 主键
- `team_id`: 所属团队
- `name`: 工作组名称
- `description`: 工作组描述/职责
- `leader_id`: 工作组组长
- `created_at`: 创建时间

---

### 4. work_group_members 表（工作组成员表）

```sql
CREATE TABLE work_group_members (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  work_group_id BIGINT REFERENCES work_groups(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(work_group_id, user_id)
);
```

**字段说明：**
- `work_group_id`: 工作组ID
- `user_id`: 成员用户ID
- `joined_at`: 加入时间

---

### 5. tasks 表（任务表）

```sql
CREATE TABLE tasks (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  team_id BIGINT REFERENCES teams(id) ON DELETE CASCADE,
  work_group_id BIGINT REFERENCES work_groups(id) ON DELETE SET NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  start_date DATE,
  end_date DATE,
  status VARCHAR(20) DEFAULT 'pending', -- pending, in_progress, completed, cancelled
  priority VARCHAR(20) DEFAULT 'medium', -- low, medium, high
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明：**
- `team_id`: 所属团队
- `work_group_id`: 负责的工作组
- `title`: 任务标题
- `description`: 任务描述
- `start_date`: 任务开始日期
- `end_date`: 任务结束日期
- `status`: 任务状态
- `priority`: 任务优先级
- `created_by`: 创建人
- `created_at`: 创建时间
- `updated_at`: 更新时间

---

### 6. work_items 表（工作子项表）

```sql
CREATE TABLE work_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  task_id BIGINT REFERENCES tasks(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  execution_order VARCHAR(20) NOT NULL, -- parallel, sequential
  sequence_number INTEGER DEFAULT 0, -- 顺序号，用于sequential类型
  planned_start_time TIMESTAMP WITH TIME ZONE,
  duration_hours DECIMAL(5,2), -- 预计时长（小时）
  planned_end_time TIMESTAMP WITH TIME ZONE,
  assignee_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  collaborators TEXT, -- JSON数组存储配合人user_id
  objectives TEXT, -- 工作目标要求
  status VARCHAR(20) DEFAULT 'pending', -- pending, in_progress, completed, cancelled, blocked
  progress INTEGER DEFAULT 0, -- 进度百分比 0-100
  actual_start_time TIMESTAMP WITH TIME ZONE,
  actual_end_time TIMESTAMP WITH TIME ZONE,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明：**
- `task_id`: 所属任务
- `title`: 子项标题
- `description`: 子项描述
- `execution_order`: 执行顺序（parallel/sequential）
- `sequence_number`: 顺序号（当execution_order为sequential时使用）
- `planned_start_time`: 计划开始时间
- `duration_hours`: 预计时长（小时）或
- `planned_end_time`: 计划完成时间（与duration二选一）
- `assignee_id`: 负责人
- `collaborators`: 配合人员列表（JSON格式）
- `objectives`: 工作目标要求
- `status`: 子项状态
- `progress`: 进度百分比
- `actual_start_time`: 实际开始时间
- `actual_end_time`: 实际结束时间
- `created_by`: 创建人
- `created_at`: 创建时间
- `updated_at`: 更新时间

**execution_order说明：**
- `parallel`: 并行执行，多个子项可以同时进行
- `sequential`: 顺序执行，按sequence_number顺序依次进行

---

### 7. work_item_status_history 表（工作子项状态历史表）

```sql
CREATE TABLE work_item_status_history (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  work_item_id BIGINT REFERENCES work_items(id) ON DELETE CASCADE,
  status VARCHAR(20) NOT NULL,
  progress INTEGER DEFAULT 0,
  changed_by UUID REFERENCES auth.users(id),
  changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**用途：** 记录工作子项的状态变更历史，用于追溯和统计

---

### 8. task_comments 表（任务评论表）

```sql
CREATE TABLE task_comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  task_id BIGINT REFERENCES tasks(id) ON DELETE CASCADE,
  work_item_id BIGINT REFERENCES work_items(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 索引设计

```sql
-- teams表索引
CREATE INDEX idx_teams_owner ON teams(owner_id);
CREATE INDEX idx_teams_created ON teams(created_at);

-- team_members表索引
CREATE INDEX idx_team_members_team ON team_members(team_id);
CREATE INDEX idx_team_members_user ON team_members(user_id);
CREATE INDEX idx_team_members_role ON team_members(role);

-- work_groups表索引
CREATE INDEX idx_work_groups_team ON work_groups(team_id);
CREATE INDEX idx_work_groups_leader ON work_groups(leader_id);

-- work_group_members表索引
CREATE INDEX idx_work_group_members_group ON work_group_members(work_group_id);
CREATE INDEX idx_work_group_members_user ON work_group_members(user_id);

-- tasks表索引
CREATE INDEX idx_tasks_team ON tasks(team_id);
CREATE INDEX idx_tasks_work_group ON tasks(work_group_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
CREATE INDEX idx_tasks_dates ON tasks(start_date, end_date);

-- work_items表索引
CREATE INDEX idx_work_items_task ON work_items(task_id);
CREATE INDEX idx_work_items_assignee ON work_items(assignee_id);
CREATE INDEX idx_work_items_status ON work_items(status);
CREATE INDEX idx_work_items_execution_order ON work_items(execution_order);
CREATE INDEX idx_work_items_sequence ON work_items(task_id, sequence_number);
CREATE INDEX idx_work_items_times ON work_items(planned_start_time, planned_end_time);

-- work_item_status_history表索引
CREATE INDEX idx_status_history_item ON work_item_status_history(work_item_id);
CREATE INDEX idx_status_history_time ON work_item_status_history(changed_at);
```

---

## RLS（行级安全）策略

### teams表RLS

```sql
-- 启用RLS
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;

-- 团队成员可以查看所属团队
CREATE POLICY "Team members can view their team" ON teams
  FOR SELECT USING (
    id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
    OR owner_id = auth.uid()
  );

-- 团队成员可以更新团队信息（仅owner/admin）
CREATE POLICY "Team members can update team" ON teams
  FOR UPDATE USING (
    id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
    OR owner_id = auth.uid()
  );

-- 只有owner可以删除团队
CREATE POLICY "Only owner can delete team" ON teams
  FOR DELETE USING (owner_id = auth.uid());
```

### team_members表RLS

```sql
ALTER TABLE team_members ENABLE ROW LEVEL SECURITY;

-- 团队成员可以查看团队成员
CREATE POLICY "Team members can view members" ON team_members
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
  );

-- 只有owner/admin可以添加成员
CREATE POLICY "Owners and admins can add members" ON team_members
  FOR INSERT WITH CHECK (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

-- 只有owner可以删除成员
CREATE POLICY "Only owners can remove members" ON team_members
  FOR DELETE USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role = 'owner'
    )
  );
```

### work_groups表RLS

```sql
ALTER TABLE work_groups ENABLE ROW LEVEL SECURITY;

-- 团队成员可以查看工作组
CREATE POLICY "Team members can view work groups" ON work_groups
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
  );

-- 只有owner/admin可以创建工作组
CREATE POLICY "Owners and admins can create work groups" ON work_groups
  FOR INSERT WITH CHECK (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

-- 只有owner/admin可以更新工作组
CREATE POLICY "Owners and admins can update work groups" ON work_groups
  FOR UPDATE USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );
```

### tasks表RLS

```sql
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

-- 团队成员可以查看任务
CREATE POLICY "Team members can view tasks" ON tasks
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
  );

-- 只有owner/admin可以创建任务
CREATE POLICY "Owners and admins can create tasks" ON tasks
  FOR INSERT WITH CHECK (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

-- 工作组成员或负责人可以更新任务
CREATE POLICY "Work group members can update tasks" ON tasks
  FOR UPDATE USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
  );
```

### work_items表RLS

```sql
ALTER TABLE work_items ENABLE ROW LEVEL SECURITY;

-- 团队成员可以查看工作子项
CREATE POLICY "Team members can view work items" ON work_items
  FOR SELECT USING (
    task_id IN (
      SELECT id FROM tasks 
      WHERE team_id IN (
        SELECT team_id FROM team_members 
        WHERE user_id = auth.uid()
      )
    )
  );

-- 工作组成员或负责人可以更新工作子项
CREATE POLICY "Assignees can update work items" ON work_items
  FOR UPDATE USING (
    assignee_id = auth.uid() OR
    task_id IN (
      SELECT id FROM tasks 
      WHERE team_id IN (
        SELECT team_id FROM team_members 
        WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
      )
    )
  );
```

---

## 数据完整性约束

```sql
-- 确保collaborators是有效的JSON格式
ALTER TABLE work_items 
  ADD CONSTRAINT valid_collaborators_json 
  CHECK (collaborators IS NULL OR jsonb_typeof(collaborators::jsonb) = 'array');

-- 确保progress在0-100之间
ALTER TABLE work_items 
  ADD CONSTRAINT valid_progress_range 
  CHECK (progress >= 0 AND progress <= 100);

-- 确保execution_order是有效值
ALTER TABLE work_items 
  ADD CONSTRAINT valid_execution_order 
  CHECK (execution_order IN ('parallel', 'sequential'));

-- 确保duration_hours为正数
ALTER TABLE work_items 
  ADD CONSTRAINT valid_duration 
  CHECK (duration_hours IS NULL OR duration_hours > 0);

-- 确保team_members的role是有效值
ALTER TABLE team_members 
  ADD CONSTRAINT valid_member_role 
  CHECK (role IN ('owner', 'admin', 'member'));

-- 确保tasks的status是有效值
ALTER TABLE tasks 
  ADD CONSTRAINT valid_task_status 
  CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled'));

-- 确保tasks的priority是有效值
ALTER TABLE tasks 
  ADD CONSTRAINT valid_task_priority 
  CHECK (priority IN ('low', 'medium', 'high'));

-- 确保work_items的status是有效值
ALTER TABLE work_items 
  ADD CONSTRAINT valid_work_item_status 
  CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled', 'blocked'));
```

---

## 触发器

### 自动更新updated_at字段

```sql
-- tasks表updated_at触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tasks_updated_at 
BEFORE UPDATE ON tasks 
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_work_items_updated_at 
BEFORE UPDATE ON work_items 
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## 数据关系图

```
teams (团队)
  ├── team_members (团队成员)
  ├── work_groups (工作组)
  │     └── work_group_members (工作组成员)
  └── tasks (任务)
        ├── task_comments (任务评论)
        └── work_items (工作子项)
              ├── work_item_status_history (状态历史)
              └── task_comments (子项评论，通过work_item_id关联)
```

---

## 迁移策略

### 从现有schedules表迁移到新结构

```sql
-- 为现有用户创建默认个人团队
INSERT INTO teams (name, owner_id, description)
SELECT 
  '个人团队' as name,
  user_id as owner_id,
  '从个人日程迁移的默认团队' as description
FROM schedules
GROUP BY user_id
ON CONFLICT DO NOTHING;

-- 创建个人工作组
INSERT INTO work_groups (team_id, name, description, leader_id)
SELECT 
  t.id as team_id,
  '默认工作组' as name,
  '个人工作默认组' as description,
  t.owner_id as leader_id
FROM teams t
WHERE t.name = '个人团队'
ON CONFLICT DO NOTHING;

-- 迁移schedules到tasks
INSERT INTO tasks (team_id, work_group_id, title, description, start_date, end_date, status, created_by, created_at)
SELECT 
  t.id as team_id,
  wg.id as work_group_id,
  s.title,
  s.description,
  s.date as start_date,
  s.date as end_date,
  s.status,
  s.user_id as created_by,
  s.created_at
FROM schedules s
JOIN teams t ON t.owner_id = s.user_id AND t.name = '个人团队'
JOIN work_groups wg ON wg.team_id = t.id AND wg.name = '默认工作组';

-- 为每个任务创建一个默认工作子项
INSERT INTO work_items (task_id, title, description, execution_order, planned_start_time, assignee_id, created_by, created_at)
SELECT 
  t.id as task_id,
  t.title,
  t.description,
  'parallel' as execution_order,
  CONCAT(t.start_date, ' ', t.time || ':00')::timestamp as planned_start_time,
  t.created_by as assignee_id,
  t.created_by,
  t.created_at
FROM tasks t
WHERE t.team_id IN (SELECT id FROM teams WHERE name = '个人团队');
```

---

## 数据清理和归档

### 归档已完成的任务

```sql
-- 创建归档表
CREATE TABLE archived_tasks (
  LIKE tasks INCLUDING ALL
);

-- 归档90天前完成的任务
INSERT INTO archived_tasks
SELECT * FROM tasks
WHERE status = 'completed' 
  AND end_date < NOW() - INTERVAL '90 days';

-- 从主表删除
DELETE FROM tasks
WHERE status = 'completed' 
  AND end_date < NOW() - INTERVAL '90 days';
```

---

## 性能优化建议

1. **定期清理历史数据**
2. **使用物化视图**缓存常用查询结果
3. **添加全文搜索**支持
4. **实现数据分区**（按时间分区work_items表）
5. **添加缓存层**（Redis）